# ビルドエラー自動修正

## 目的

npm run build と npm run test を成功するまでエラーを修正し続ける

## 実行手順

1. **テストコマンド存在確認**

   - bash ツールで `cat package.json` を実行
   - scripts 内に test コマンドが存在するか確認
   - 存在しない場合: テスト実行はスキップ

2. **初回ビルド実行**

   - bash ツールで `npm run build` を実行
   - ビルド結果を確認

3. **初回テスト実行**

   - テストコマンドが存在する場合のみ実行
   - bash ツールで `npm run test` を実行
   - テスト結果を確認

4. **成功判定**

   - ビルドが成功 かつ (テストコマンドが存在しない または テストが成功):
     → 「ビルド成功」(テストがある場合は「ビルド・テスト成功」)と通知して終了

5. **エラー解析**

   - ビルドエラーとテストエラーのログを解析
   - エラーの種類を分類:
     - 型エラー
     - 構文エラー
     - インポートエラー
     - 未定義変数/関数
     - テスト失敗(アサーションエラー)
     - その他のエラー
   - エラーが発生しているファイルとパスを特定

6. **修正可能性の判断**

   - 以下の場合はユーザーに相談:
     - ビルド設定の変更が必要と判断される場合
     - テスト設定の変更が必要と判断される場合
     - 既存機能の仕様変更が必要な場合
     - エラーの原因が不明確な場合
     - 同じエラーが 3 回連続で発生した場合
     - 修正がアプリケーションのロジックに影響する場合
     - テストの期待値変更が必要な場合

7. **エラー修正**

   - ファイル編集ツールを使用してエラーを修正
   - 修正方針:
     - 型エラー: 正しい型定義を追加/修正
     - 構文エラー: 構文を修正
     - インポートエラー: インポートパスを修正
     - 未定義変数/関数: 定義を追加または参照を修正
     - テスト失敗: テストコードの型エラーやインポートエラーを修正(期待値は変更しない)
   - 修正内容をログに記録

8. **再ビルド・再テスト**

   - bash ツールで `npm run build` を再実行
   - テストコマンドが存在する場合は `npm run test` を再実行
   - 手順 4 に戻る

9. **修正完了通知**
   - 修正したファイルの一覧を出力
   - 修正内容の要約を出力
   - ビルド・テスト成功を通知

## 制約条件

### 変更禁止対象

以下のファイルは原則として変更しない:

- package.json (依存関係、scripts)
- tsconfig.json
- next.config.js (または類似のビルド設定ファイル)
- .babelrc
- webpack.config.js
- vite.config.js
- jest.config.js
- vitest.config.js

### 修正範囲の制限

- 既存の関数やコンポーネントのロジックは変更しない
- API エンドポイントの仕様は変更しない
- データベーススキーマに影響する変更は行わない
- 環境変数の追加/削除は行わない
- テストの期待値(expect 値)は変更しない
- テストのアサーション内容は変更しない

### 安全性確保

- 型定義の追加は許可
- 未使用変数の削除は許可
- インポートパスの修正は許可
- 構文エラーの修正は許可
- コメントの追加は許可
- テストファイルの型エラー修正は許可
- テストファイルのインポートエラー修正は許可

## エラーハンドリング

- 10 回の修正試行でビルド・テストが成功しない → ユーザーに相談して終了
- package.json が存在しない → 「package.json が見つかりません」と通知して終了
- npm/node が利用不可 → 「npm コマンドが利用できません」と通知して終了

## ユーザー相談が必要なケース

以下の場合は修正を中断しユーザーに相談:

1. ビルド設定の変更が必要
2. テスト設定の変更が必要
3. 外部ライブラリのバージョン変更が必要
4. 既存機能の仕様変更が必要
5. エラーの原因が特定できない
6. 修正がデータフローに影響する
7. 同一エラーが繰り返し発生(3 回以上)
8. テストの期待値変更が必要

相談時の出力内容:

- エラーの詳細
- 試行した修正内容
- 現在の状況
- 推奨される対応策(複数案)

## 制約

- 全ての出力は日本語
- 修正履歴を記録
- 各修正後に必ずビルドを実行
- テストコマンドが存在する場合は各修正後にテストも実行
