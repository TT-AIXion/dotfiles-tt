# Draw.io フローチャート自動生成

指定された対象（CI/CD、処理フロー、アーキテクチャなど)を解析し、`.cursor/rules/drawio.mdc` のスタイルガイドラインに従って Draw.io 形式のフローチャートを生成する。

---

## 使用方法

### 基本的な使用

```bash
/gen-drawio-flow [対象の説明またはファイルパス]
```

**例:**

- `/gen-drawio-flow .gitlab-ci.yml` → GitLab CI パイプラインのフローチャート
- `/gen-drawio-flow Makefile` → Make コマンドの処理フロー
- `/gen-drawio-flow src/utils/auth.ts` → 認証処理のフローチャート
- `/gen-drawio-flow ユーザー登録フロー` → 概念的なフローの図式化

どんなオプションでもそれについて必ず drawio ファイルを生成すること。
ユーザーに確認を求める必要はなく、実装を確認してからファイルを生成しタスクを完了とすること。

**重要**: 生成後は必ず **draw.io CLI（drawio コマンド）** を使用して SVG にエクスポートし、**視覚的に線の重なりやレイアウト崩れがないか確認**すること。問題があれば修正し、問題がないことを確認した後、エクスポートした画像は削除してからタスク完了とする。

## 事前準備（必須）

### 1. スタイルガイドラインの読み込み

**必ず最初に** `.cursor/rules/drawio.mdc` を読み込み、以下を確認：

- カラーパレット（プライマリカラー、図形カラー、テキストカラー）
- 図形スタイル（開始/終了、処理、条件分岐、スイムレーン）
- フォントサイズ規定
- レイアウトガイドライン

### 2. 対象の解析

- ファイルが指定された場合：コードを読み込み、処理フローを把握
- 概念が指定された場合：関連するコードやドキュメントを検索

---

## 出力ファイル構成

```text
dev-docs/
└── [カテゴリ]/
    └── [対象名]-flow.drawio
```

**例:**

- `dev-docs/gitlab-ci/gitlab-ci-flow.drawio`
- `dev-docs/commands/make-run/flow.drawio`
- `dev-docs/architecture/auth-flow.drawio`

---

## 生成ルール

### 1. 必須要素

すべての図に以下を含める:

| 要素      | 説明                                 |
| --------- | ------------------------------------ |
| タイトル  | 図の目的を明示（24px, bold）         |
| 凡例      | 使用する図形と色の意味（右上に配置） |
| 開始/終了 | 明確な開始点と終了点                 |
| 接続線    | すべてのノードが接続されている       |

### 2. カラールール

**スタイルガイドラインから適用:**

```text
プライマリカラー（ステージ用）:
- Blue (#1a73e8)   - 情報系、ステージ1
- Green (#34a853)  - 成功系、ステージ2
- Red (#ea4335)    - 警告・削除系、ステージ3
- Yellow (#fbbc04) - 注意系、ステージ4
- Gray (#5f6368)   - 中立系、ステージ5

図形カラー（ノード用）:
- 開始/終了:   fillColor=#d5e8d4, strokeColor=#82b366
- 通常処理:    fillColor=#dae8fc, strokeColor=#6c8ebf
- 条件分岐:    fillColor=#fff2cc, strokeColor=#d6b656
- 認証/設定:   fillColor=#e1d5e7, strokeColor=#9673a6
- エラー/削除: fillColor=#f8cecc, strokeColor=#b85450
- スキップ:    fillColor=#f5f5f5, strokeColor=#666666
```

### 3. 図形ルール

| 図形         | 用途         | スタイル    |
| ------------ | ------------ | ----------- |
| 楕円         | 開始/終了    | `ellipse`   |
| 角丸四角形   | 処理         | `rounded=1` |
| 菱形         | 条件分岐     | `rhombus`   |
| スイムレーン | ステージ分離 | `swimlane`  |

### 4. 接続線ルール

- **通常接続**: `edgeStyle=orthogonalEdgeStyle`（直角）
- **Yes ラベル**: `fontColor=#009900`（緑）
- **No ラベル**: `fontColor=#CC0000`（赤）
- 条件分岐の Yes は下または左、No は右
- **重要**: ラベルテキストは独立した `mxCell` として配置せず、必ず接続線（edge）の子要素として埋め込むこと
  - 独立したテキストボックスではなく、`edgeLabel` スタイルを使用
  - `parent` 属性で親エッジの ID を指定
  - `mxGeometry` で `relative="1"` を設定し、線に沿った相対位置で配置
  - これにより、接続線とラベルが一体化し、移動時も連動する

**ラベルの正しい実装例:**

```xml
<!-- 悪い例: 独立したテキストボックス -->
<mxCell id="e3-label" value="No" style="text;html=1;fontSize=10;fontColor=#CC0000;" parent="stage1" vertex="1">
    <mxGeometry x="225" y="190" width="30" height="20" as="geometry"/>
</mxCell>

<!-- 良い例: エッジの子要素として埋め込み -->
<mxCell id="e3" style="edgeStyle=orthogonalEdgeStyle;..." parent="stage1" source="cors-check" target="cors-error" edge="1">
    <mxGeometry relative="1" as="geometry"/>
</mxCell>
<mxCell value="No" style="edgeLabel;html=1;align=center;verticalAlign=middle;resizable=0;points=[];fontSize=10;fontColor=#CC0000;" vertex="1" connectable="0" parent="e3">
    <mxGeometry x="-0.2" y="1" relative="1" as="geometry">
        <mxPoint as="offset"/>
    </mxGeometry>
</mxCell>
```

---

## 図の種類別テンプレート

### フローチャート（flowchart）

```text
方向: 上から下
構成:
  - 開始（楕円・緑）
  - 処理（角丸四角形・青）
  - 条件分岐（菱形・黄）
  - 終了（楕円・緑）
```

### CI/CD パイプライン（pipeline）

```text
方向: 左から右
構成:
  - スイムレーン（ステージごとに色分け）
  - ジョブタイトル（ステージ内ヘッダー）
  - 処理フロー（各ジョブ内）
  - ステージ間の接続矢印
  - 順序番号（①②③）
```

### アーキテクチャ図（architecture）

```text
方向: 自由配置
構成:
  - サービス（角丸四角形）
  - データベース（円筒形）
  - 外部システム（グレー四角形）
  - 接続線（矢印付き）
```

---

## 処理手順

### 1. ルール読み込み

```text
.cursor/rules/drawio.mdc を読み込む
→ カラーパレット、図形スタイル、レイアウトルールを把握
```

### 2. 対象解析

```text
ファイルまたは概念を解析
→ 処理フローの構造を把握
→ ノード（処理、条件分岐）を特定
→ 接続関係を特定
```

### 3. 図の設計

```text
図の種類を決定
→ キャンバスサイズを決定
→ スイムレーン or 単一フローを決定
→ ノード配置を計画
```

### 4. XML 生成

```text
mxfile 構造を生成
→ 各ノードの mxCell を生成
→ 接続線（edge）を生成
  - ラベルは必ずエッジの子要素として埋め込む
  - edgeLabel スタイルを使用
  - relative geometry で配置
→ 凡例を追加
```

### 5. ファイル出力

```text
dev-docs/最適と思われる分類/ .drawio にファイルを保存
→ 生成結果を報告
```

### 6. 視覚的検証（必須）

生成した drawio ファイルを **CLI で SVG にエクスポート**して視覚的に確認する。

#### 事前準備: draw.io CLI のインストール

drawio コマンドが存在しない場合、以下の手順で自動インストールする。

**Mac の場合:**

```bash
# Homebrew でインストール
brew install --cask drawio
```

**Windows の場合:**

```bash
# winget でインストール（推奨）
winget install JGraph.Draw

# または Chocolatey でインストール
choco install drawio
```

**インストール確認:**

```bash
# バージョン確認（パスが通っていることを確認）
drawio --version
```

> **注意**: インストール後、ターミナルの再起動が必要な場合がある。

#### 検証手順

1. **SVG にエクスポート**

   ```bash
   # drawio CLI を使用して SVG にエクスポート
   drawio -x -f svg -o [対象名]-flow.svg [対象名]-flow.drawio
   ```

2. **SVG ファイルを Read ツールで確認**

   ```text
   Read ツールで SVG ファイルを読み込み、画像として視覚的に確認
   → 線の重なり、ノードの重なり、レイアウト崩れをチェック
   ```

3. **視覚的チェック項目**

   | チェック項目     | 確認内容                                                                 |
   | ---------------- | ------------------------------------------------------------------------ |
   | 線の重なり       | 接続線同士が重なっていないか                                             |
   | ノードの重なり   | 図形同士が重なっていないか                                               |
   | ラベルの可読性   | テキストが切れたり重なったりしていないか                                 |
   | 全体のバランス   | 図全体が見やすく配置されているか                                         |
   | 接続線の経路     | 線が不自然なルートを通っていないか                                       |
   | スイムレーン境界 | スイムレーンをまたぐ要素が正しく配置されているか                         |
   | ラベルの連動性   | 接続線とラベルが一体化しているか（独立テキストボックスになっていないか） |

4. **問題発見時の対応**

   ```text
   問題が見つかった場合:
   → drawio ファイルを修正
   → 再度 SVG エクスポート → 視覚的検証を実施
   → 問題が解消されるまで繰り返す
   ```

5. **エクスポートファイルの削除（必須）**

   ```bash
   # 確認完了後、エクスポートした SVG ファイルを削除
   rm [対象名]-flow.svg
   ```

   **注意**: 視覚的検証が完了し問題がないことを確認した後、必ずエクスポートした画像ファイルを削除すること。drawio ファイルのみをリポジトリに残す。

---

## 品質チェックリスト

生成完了後、以下を確認:

### 必須チェック

- [ ] `.cursor/rules/drawio.mdc` のカラーパレットを使用している
- [ ] タイトルが図の目的を明確に示している
- [ ] 凡例が含まれている（3 種類以上の図形使用時）
- [ ] すべてのノードが接続されている
- [ ] 開始と終了が明確である
- [ ] 条件分岐に Yes/No ラベルがある
- [ ] **ラベルが接続線の子要素として正しく埋め込まれている（独立テキストボックスではない）**

### スタイルチェック

- [ ] フォントサイズがガイドラインに従っている
- [ ] グリッド（10px 単位）に沿って配置されている
- [ ] ノード間隔が 20px 以上確保されている
- [ ] 色の使い方が一貫している
- [ ] エッジラベルは `edgeLabel` スタイルを使用している

### 内容チェック

- [ ] 処理フローが正確に表現されている
- [ ] 条件分岐のロジックが正しい
- [ ] エラーハンドリングパスが含まれている（該当する場合）

### 視覚的検証チェック（必須）

- [ ] **SVG にエクスポートして視覚的に確認した**
- [ ] 接続線同士が重なっていない
- [ ] ノード同士が重なっていない
- [ ] テキストラベルが切れたり重なったりしていない
- [ ] 全体のレイアウトバランスが良い
- [ ] **確認後、エクスポートした SVG ファイルを削除した**

---

## 出力例

### 生成されるファイル構造

```xml
<?xml version='1.0' encoding='utf-8'?>
<mxfile host="Electron" ...>
  <diagram id="..." name="...">
    <mxGraphModel ...>
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>
        <!-- タイトル -->
        <!-- 凡例 -->
        <!-- スイムレーン/ノード -->
        <!-- 接続線（エッジ） -->
          <!-- エッジラベル（子要素として埋め込み） -->
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
```

---

## 注意事項

### 必須

- **必ず** `.cursor/rules/drawio.mdc` を最初に読み込むこと
- カラーコードは**ガイドラインの値をそのまま使用**すること
- XML は**正しい形式**で出力すること（Draw.io で開けるように）
- **接続線のラベルは必ずエッジの子要素として埋め込むこと**（独立したテキストボックスとして配置しない）

### 推奨

- 複雑なフローは複数の図に分割することを検討
- 処理の説明テキストは簡潔に（改行は `&#10;` を使用）
- 重要な注意事項は警告ボックス（黄色・破線）で強調

### 禁止

- ガイドラインにないカラーコードの使用
- フォントサイズのガイドライン逸脱
- 凡例なしでの複雑な図の作成
- **接続線ラベルを独立したテキストボックス（mxCell with parent=swimlane）として配置すること**
  - 必ず `parent=<edge-id>` として埋め込むこと
  - `edgeLabel` スタイルを使用すること
  - `relative="1"` の geometry を使用すること
